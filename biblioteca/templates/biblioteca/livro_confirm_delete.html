{% extends 'base.html' %}
{% load static %}

{% block title %}Excluir Livro - Sistema de Biblioteca SENAC{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'biblioteca:dashboard' %}">
                <i class="fas fa-home me-1"></i>Dashboard
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'biblioteca:livro_list' %}">
                <i class="fas fa-books me-1"></i>Livros
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'biblioteca:livro_detail' object.pk %}">
                {{ object.titulo|truncatechars:30 }}
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Excluir</li>
    </ol>
</nav>

<!-- Confirmation Header -->
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="text-center mb-4">
            <div class="mb-3">
                <i class="fas fa-exclamation-triangle fa-4x text-warning"></i>
            </div>
            <h1 class="h2 text-danger mb-2">Confirmar Exclusão</h1>
            <p class="text-muted">Esta ação não pode ser desfeita</p>
        </div>
        
        <!-- Book Information Card -->
        <div class="card border-danger mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-book me-2"></i>
                    Livro a ser Excluído
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Book Cover -->
                    <div class="col-md-3 text-center mb-3">
                        {% if object.capa %}
                            <img src="{{ object.capa.url }}" 
                                 alt="Capa de {{ object.titulo }}" 
                                 class="img-fluid rounded shadow-sm" 
                                 style="max-height: 150px; object-fit: cover;">
                        {% else %}
                            <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                                 style="height: 150px;">
                                <i class="fas fa-book fa-3x text-muted"></i>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Book Details -->
                    <div class="col-md-9">
                        <h5 class="card-title text-danger">{{ object.titulo }}</h5>
                        <p class="text-muted mb-2">
                            <i class="fas fa-user me-2"></i>
                            <strong>Autor:</strong> {{ object.autor.nome }}
                        </p>
                        <p class="mb-2">
                            <span class="badge bg-secondary">{{ object.get_genero_display }}</span>
                        </p>
                        
                        <!-- Book Statistics -->
                        <div class="row mb-3">
                            <div class="col-4 text-center">
                                <div class="p-2 bg-light rounded">
                                    <div class="h6 mb-1 text-primary">{{ object.quantidade }}</div>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="p-2 bg-light rounded">
                                    <div class="h6 mb-1 text-success">{{ object.quantidade_disponivel }}</div>
                                    <small class="text-muted">Disponível</small>
                                </div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="p-2 bg-light rounded">
                                    <div class="h6 mb-1 text-info">{{ object.get_total_loans }}</div>
                                    <small class="text-muted">Empréstimos</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Registration Date -->
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            Cadastrado em: {{ object.data_cadastro|date:"d/m/Y H:i" }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Safety Checks -->
        <div class="card border-warning mb-4">
            <div class="card-header bg-warning text-dark">
                <h6 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Verificações de Segurança
                </h6>
            </div>
            <div class="card-body">
                {% with emprestimos_ativos=object.emprestimos.all reservas_ativas=object.reservas.all %}
                    <!-- Active Loans Check -->
                    {% if emprestimos_ativos %}
                        <div class="alert alert-danger mb-3" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading">Empréstimos Ativos!</h6>
                                    <p class="mb-0">
                                        Este livro possui {{ emprestimos_ativos|length }} empréstimo(s) ativo(s) e 
                                        <strong>NÃO PODE</strong> ser excluído até que todos sejam devolvidos.
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Active Reservations Check -->
                    {% if reservas_ativas %}
                        <div class="alert alert-warning mb-3" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock fa-2x me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading">Reservas Ativas!</h6>
                                    <p class="mb-0">
                                        Este livro possui {{ reservas_ativas|length }} reserva(s) ativa(s) e 
                                        <strong>NÃO PODE</strong> ser excluído até que todas sejam canceladas.
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Safe to Delete -->
                    {% if not emprestimos_ativos and not reservas_ativas %}
                        <div class="alert alert-success" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle fa-2x me-3"></i>
                                <div>
                                    <h6 class="alert-heading">Seguro para Exclusão</h6>
                                    <p class="mb-0">
                                        Este livro não possui empréstimos ativos ou reservas pendentes. 
                                        Pode ser excluído com segurança.
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endwith %}
            </div>
        </div>
        
        <!-- Impact Warning -->
        <div class="card border-info mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Impacto da Exclusão
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6 class="text-info">O que será perdido:</h6>
                        <ul class="text-muted small">
                            <li>Dados do livro permanentemente</li>
                            <li>Histórico de empréstimos</li>
                            <li>Reservas antigas</li>
                            <li>Arquivo de capa (se existir)</li>
                        </ul>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6 class="text-info">Alternativas recomendadas:</h6>
                        <ul class="text-muted small">
                            <li>Marcar como "Indisponível"</li>
                            <li>Mover para "Arquivado"</li>
                            <li>Atualizar informações</li>
                            <li>Corrigir dados incorretos</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="card border-0 bg-light">
            <div class="card-body text-center">
                {% with emprestimos_ativos=object.emprestimos.all reservas_ativas=object.reservas.all %}
                    {% if emprestimos_ativos or reservas_ativas %}
                        <!-- Cannot Delete - Show Warning -->
                        <div class="alert alert-warning mb-3" role="alert">
                            <i class="fas fa-ban me-2"></i>
                            <strong>Exclusão Bloqueada:</strong> 
                            Este livro não pode ser excluído no momento.
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-center">
                            <a href="{% url 'biblioteca:livro_detail' object.pk %}" class="btn btn-primary">
                                <i class="fas fa-eye me-2"></i>Ver Detalhes
                            </a>
                            <a href="{% url 'biblioteca:livro_update' object.pk %}" class="btn btn-outline-primary">
                                <i class="fas fa-edit me-2"></i>Editar Livro
                            </a>
                            <a href="{% url 'biblioteca:livro_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Voltar à Lista
                            </a>
                        </div>
                    {% else %}
                        <!-- Can Delete - Show Confirmation -->
                        <div class="mb-4">
                            <h5 class="text-danger mb-3">Tem certeza que deseja excluir este livro?</h5>
                            <p class="text-muted">
                                Digite <strong>"EXCLUIR"</strong> no campo abaixo para confirmar
                            </p>
                        </div>
                        
                        <form method="post" id="deleteForm">
                            {% csrf_token %}
                            <div class="row justify-content-center mb-4">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-keyboard"></i>
                                        </span>
                                        <input type="text" 
                                               class="form-control" 
                                               id="confirmationText" 
                                               placeholder="Digite EXCLUIR para confirmar"
                                               required>
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Esta medida de segurança previne exclusões acidentais
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2 justify-content-center">
                                <a href="{% url 'biblioteca:livro_list' %}" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </a>
                                
                                <button type="submit" 
                                        class="btn btn-danger btn-lg" 
                                        id="deleteButton" 
                                        disabled>
                                    <i class="fas fa-trash me-2"></i>Confirmar Exclusão
                                </button>
                            </div>
                        </form>
                    {% endif %}
                {% endwith %}
            </div>
        </div>
        
        <!-- Additional Safety Info -->
        <div class="text-center mt-4">
            <div class="alert alert-light" role="alert">
                <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>
                    <strong>Dica de Segurança:</strong> 
                    Sempre verifique se não há empréstimos ou reservas ativas antes de excluir um livro.
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Card styling */
.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-1px);
}

/* Warning icon styling */
.fa-exclamation-triangle {
    color: #ffc107;
}

/* Danger styling */
.text-danger {
    font-weight: 600;
}

/* Button styling */
.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
}

/* Form validation */
.form-control:focus {
    border-color: var(--danger-color);
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .card-body {
        padding: 1.5rem;
    }
    
    .d-flex.gap-2 {
        flex-direction: column;
    }
    
    .d-flex.gap-2 .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmationText = document.getElementById('confirmationText');
    const deleteButton = document.getElementById('deleteButton');
    
    if (confirmationText && deleteButton) {
        // Enable/disable delete button based on confirmation text
        confirmationText.addEventListener('input', function() {
            if (this.value.trim().toUpperCase() === 'EXCLUIR') {
                deleteButton.disabled = false;
                deleteButton.classList.remove('btn-outline-danger');
                deleteButton.classList.add('btn-danger');
            } else {
                deleteButton.disabled = true;
                deleteButton.classList.remove('btn-danger');
                deleteButton.classList.add('btn-outline-danger');
            }
        });
        
        // Form submission validation
        const form = document.getElementById('deleteForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                if (confirmationText.value.trim().toUpperCase() !== 'EXCLUIR') {
                    e.preventDefault();
                    
                    // Show error message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                    alertDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Erro:</strong> Digite "EXCLUIR" para confirmar a exclusão.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    form.appendChild(alertDiv);
                    
                    // Auto-hide after 5 seconds
                    setTimeout(function() {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 5000);
                    
                    // Focus on confirmation field
                    confirmationText.focus();
                } else {
                    // Show final confirmation dialog
                    if (!confirm('ATENÇÃO: Esta ação é irreversível! Tem certeza que deseja excluir o livro "' + 
                               '{{ object.titulo }}' + '" permanentemente?')) {
                        e.preventDefault();
                    }
                }
            });
        }
    }
    
    // Auto-focus on confirmation field
    if (confirmationText) {
        confirmationText.focus();
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape key to cancel
        if (e.key === 'Escape') {
            window.location.href = "{% url 'biblioteca:livro_list' %}";
        }
        
        // Enter key to submit (if confirmation is valid)
        if (e.key === 'Enter' && confirmationText && deleteButton) {
            if (confirmationText.value.trim().toUpperCase() === 'EXCLUIR' && !deleteButton.disabled) {
                document.getElementById('deleteForm').submit();
            }
        }
    });
    
    // Prevent accidental form submission
    window.addEventListener('beforeunload', function(e) {
        if (confirmationText && confirmationText.value.trim().toUpperCase() === 'EXCLUIR') {
            e.preventDefault();
            e.returnValue = 'Você tem certeza que deseja sair? As alterações podem ser perdidas.';
        }
    });
});
</script>
{% endblock %}
